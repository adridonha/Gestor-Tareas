<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Tareas</title>
    <link rel="stylesheet" href="./css/styles.css">
    <script src="./js/code.js" defer></script>
</head>
<body>
    <h1>Lista de Tareas</h1>

    <!-- Form to add a new task -->
    <form id="task-form">
        <input type="text" id="task-name" placeholder="Task Name" required />
        <textarea id="task-description" placeholder="Task Description" required></textarea>
        <select id="task-state">
            <option value="Pendiente">Pendiente</option>
            <option value="Iniciada">Iniciada</option>
            <option value="Completada">Completada</option>
            <option value="Retrasada">Retrasada</option>
        </select>
        <input type="date" id="task-date" required />
        <button type="submit">Add Task</button>
    </form>

    <!-- Task Table -->
    <table id="task-table">
        <thead>
            <tr>
                <th>Task ID</th>
                <th>Task Name</th>
                <th>Task Description</th>
                <th>Task State</th>
                <th>Task Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="task-list"></tbody>
    </table>

    <!-- Edit Task Dialog -->
    <dialog id="edit-dialog">
        <div class="dialog-container">
            <h3>Edit Task</h3>
            <input type="text" id="edit-task-name" placeholder="Task Name" required />
            <textarea id="edit-task-description" placeholder="Task Description" required></textarea>
            <select id="edit-task-state">
                <option value="Pendiente">Pendiente</option>
                <option value="Iniciada">Iniciada</option>
                <option value="Completada">Completada</option>
                <option value="Retrasada">Retrasada</option>
            </select>
            <input type="date" id="edit-task-date" required />
            <button id="save-task-btn">Save Changes</button>
            <button id="cancel-edit-btn">Cancel</button>
        </div>
    </dialog>

    <script>
      let currentEditingTaskId = null;

      // Function to format the date as DD-MM-YYYY
      const formatDateDisplay = (dateString) => {
          // Ensure the date string is in YYYY-MM-DD format (or something like it)
          const date = new Date(dateString);

          const day = String(date.getDate()).padStart(2, '0'); // Get day and pad it to 2 digits
          const month = String(date.getMonth() + 1).padStart(2, '0'); // Get month and pad it
          const year = date.getFullYear(); // Get the year

          return `${day}-${month}-${year}`; // Return in DD-MM-YYYY format
      };


  
      // Fetch tasks and display them
      const fetchTasks = () => {
          fetch('http://localhost:3000/api/tasks')
              .then(response => response.json())
              .then(data => {
                  const taskList = document.getElementById('task-list');
                  taskList.innerHTML = ''; // Clear the list before adding new tasks
                  data.forEach(task => {
                      const row = document.createElement('tr');
                      
                      // Display task fields
                      row.innerHTML = `
                          <td>${task.task_id}</td>
                          <td>${task.task_name}</td>
                          <td>${task.task_description}</td>
                          <td>${task.task_state}</td>
                          <td>${formatDateDisplay(task.task_date)}</td>
                          <td>
                              <button onclick="openEditDialog(${task.task_id})">Edit</button>
                              <button onclick="deleteTask(${task.task_id})">Delete</button>
                          </td>
                      `;
                      taskList.appendChild(row);
                  });
              })
              .catch(error => console.error('Error fetching tasks:', error));
      };
  
      // Add a new task
      const addTask = (event) => {
          event.preventDefault(); // Prevent the default form submission
  
          // Get form data
          const task_name = document.getElementById('task-name').value;
          const task_description = document.getElementById('task-description').value;
          const task_state = document.getElementById('task-state').value;
          const task_date = document.getElementById('task-date').value;
  
          // Send a POST request to add the task
          fetch('http://localhost:3000/api/tasks', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ task_name, task_description, task_state, task_date })
          })
          .then(response => response.json())
          .then(() => {
              fetchTasks(); // Reload tasks after adding
              document.getElementById('task-form').reset(); // Reset the form
          })
          .catch(error => console.error('Error adding task:', error));
      };
  
      // Open the Edit Task dialog
      // Function to format date from YYYY-MM-DD format
const formatDate = (dateString) => {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
    const day = String(date.getDate()).padStart(2, '0');

    return `${year}-${month}-${day}`; // Return in YYYY-MM-DD format
};

const openEditDialog = (taskId) => {
    currentEditingTaskId = taskId;

    // Fetch the task data and fill the dialog fields
    fetch(`http://localhost:3000/api/tasks/${taskId}`)
        .then(response => response.json())
        .then(task => {
            if (!task) {
                console.error("Task not found");
                return;
            }

            // Ensure we have the correct data before setting the values
            document.getElementById('edit-task-name').value = task.task_name || '';
            document.getElementById('edit-task-description').value = task.task_description || '';
            document.getElementById('edit-task-state').value = task.task_state || 'Pendiente';
            
            // Format the task date before setting it in the date input
            document.getElementById('edit-task-date').value = formatDate(task.task_date) || '';

            // Open the dialog
            document.getElementById('edit-dialog').showModal();
        })
        .catch(error => console.error('Error fetching task for editing:', error));
};

  
      // Save the task after editing
      const saveTask = () => {
          const task_name = document.getElementById('edit-task-name').value;
          const task_description = document.getElementById('edit-task-description').value;
          const task_state = document.getElementById('edit-task-state').value;
          const task_date = document.getElementById('edit-task-date').value;
  
          fetch(`http://localhost:3000/api/tasks/${currentEditingTaskId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ task_name, task_description, task_state, task_date })
          })
          .then(response => response.json())
          .then(() => {
              fetchTasks(); // Reload tasks after updating
              document.getElementById('edit-dialog').close(); // Close the dialog
          })
          .catch(error => console.error('Error saving task:', error));
      };
  
      // Delete a task
      const deleteTask = (taskId) => {
          fetch(`http://localhost:3000/api/tasks/${taskId}`, {
              method: 'DELETE'
          })
          .then(() => fetchTasks())  // Reload tasks after deletion
          .catch(error => console.error('Error deleting task:', error));
      };
  
      // Initialize the page
      document.getElementById('task-form').addEventListener('submit', addTask); // Add task event listener
      document.getElementById('save-task-btn').addEventListener('click', saveTask); // Save task event listener
      document.getElementById('cancel-edit-btn').addEventListener('click', () => {
          document.getElementById('edit-dialog').close(); // Cancel edit
      });
  
      fetchTasks(); // Initial task loading
  </script>
  
  

</body>
</html>
